<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<LINK REL="stylesheet" HREF="book.css" TYPE="text/css">
<TITLE>
Prevent external processes from blocking on input and output streams [BD.PB.PBIOS]
</TITLE>
</HEAD>
<BODY BGCOLOR=#FFFFFF>
<STRONG>
Prevent external processes from blocking on input and output streams [BD.PB.PBIOS]
</STRONG>
<p>
<BR><BR>
<STRONG>
DESCRIPTION
</STRONG>
<PRE>
This rule detects cases when there is new process created using one of the following methods:
- java.lang.Runtime.exec(String command)
- java.lang.ProcessBuilder.start()
and this process has its input stream or error stream not read.


</PRE>
<STRONG>
SINCE
</STRONG>
<PRE>
v10.2


</PRE>
<STRONG>
NOTES
</STRONG>
<PRE>
N/A


</PRE>
<STRONG>
SECURITY RELEVANCE
</STRONG>
<PRE>
Processes may require input to be sent to their input stream, and they may also produce output 
on their error stream. Incorrect handling of such external programs can cause unexpected 
exceptions, denial of service (DoS), and other security problems.


</PRE>
<STRONG>
PARAMETERS
</STRONG>
<PRE>
N/A


</PRE>
<STRONG>
BENEFITS
</STRONG>
<PRE>
Makes sure the code is safe and secure.


</PRE>
<STRONG>
DRAWBACKS
</STRONG>
<PRE>
N/A


</PRE>
<STRONG>
EXAMPLE
</STRONG>
<PRE>
Here is an example that will trigger a violation.

public class Example
{
    public void example(String command)
        throws Exception
    {
        Runtime rt = Runtime.getRuntime();
        Process proc = rt.exec(command);
        proc.waitFor();
    } // VIOLATION
}



</PRE>
<STRONG>
REPAIR
</STRONG>
<PRE>
This compliant solution spawns two threads to consume the process's output stream and error stream. 
Consequently, the process cannot block indefinitely on those streams.

import java.io.IOException;
import java.io.InputStream;
import java.io.PrintStream;

public class Repair
{
    class StreamGobbler
        implements Runnable
    {
        private final InputStream is;

        private final PrintStream os;

        StreamGobbler(InputStream is, PrintStream os)
        {
            this.is = is;
            this.os = os;
        }

        public void run()
        {
            try {
                int c;
                while ((c = is.read()) != -1) {
                    os.print((char)c);
                }
            } catch (IOException x) {
                // Handle error
            }
        }
    }

    public void repair(String command)
        throws Exception
    {
        Runtime rt = Runtime.getRuntime();
        Process proc = rt.exec(command);
        Thread errorGobbler = new Thread(new StreamGobbler(proc.getErrorStream(), System.err));
        Thread outputGobbler = new Thread(new StreamGobbler(proc.getInputStream(), System.out));
        errorGobbler.start();
        outputGobbler.start();
        proc.waitFor();
        errorGobbler.join();
        outputGobbler.join();
    } // NO VIOLATION
}


</PRE>
<STRONG>
REFERENCES
</STRONG>
<PRE>

SEI CERT Oracle Coding Standard for Java
FIO07-J. Do not let external processes block on IO buffers
<A HREF="https://www.securecoding.cert.org/confluence/display/java/FIO07-J.+Do+not+let+external+processes+block+on+IO+buffers">https://www.securecoding.cert.org/confluence/display/java/FIO07-J.+Do+not+let+external+processes+block+on+IO+buffers</A>

Tags: CERT

</PRE>
</BODY>
</HTML>
